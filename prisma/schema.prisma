generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ------------------------------------------------------------
// Enums
// ------------------------------------------------------------

enum UserRole {
  ADMIN
  EXECUTIVE
  ANALYST
  VIEWER
}

enum Trend {
  UP
  DOWN
  NEUTRAL
}

enum KpiFormat {
  PERCENTAGE
  CURRENCY
  NUMBER
}

enum Currency {
  USD
  EUR
  GBP
}

// ------------------------------------------------------------
// Core Reference Tables
// ------------------------------------------------------------

model Sector {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organizations Organization[]
  departments   Department[]
  kpis          KpiDefinition[]
  users         User[]
  snapshots     ProfitabilitySnapshot[]
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  region    String?
  timezone  String?
  sectorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sector            Sector                   @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  users             User[]
  snapshots         ProfitabilitySnapshot[]
  departments       OrganizationDepartment[]
  departmentMetrics DepartmentMetric[]

  @@unique([name, sectorId])
}

model Department {
  id        String   @id @default(cuid())
  name      String
  code      String?
  sectorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sector        Sector                   @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  metrics       DepartmentMetric[]
  organizations OrganizationDepartment[]

  @@unique([name, sectorId])
}

model OrganizationDepartment {
  id             String   @id @default(cuid())
  organizationId String
  departmentId   String
  createdAt      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department   @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([organizationId, departmentId])
}

// ------------------------------------------------------------
// Users & Auth
// ------------------------------------------------------------

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  firstName      String?
  lastName       String?
  role           UserRole  @default(EXECUTIVE)
  hashedPassword String?
  googleId       String?   @unique
  phone          String?
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  sectorId       String?
  organizationId String?

  sector       Sector?       @relation(fields: [sectorId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
}

// ------------------------------------------------------------
// Profitability + KPI Data
// ------------------------------------------------------------

model ProfitabilitySnapshot {
  id              String   @id @default(cuid())
  organizationId  String
  sectorId        String
  periodStart     DateTime
  periodEnd       DateTime
  currency        Currency @default(USD)
  revenue         Decimal  @db.Decimal(18, 2)
  cost            Decimal  @db.Decimal(18, 2)
  profit          Decimal  @db.Decimal(18, 2)
  grossMargin     Float
  operatingMargin Float
  netMargin       Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization      Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sector            Sector             @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  departmentMetrics DepartmentMetric[]
  costEntries       CostEntry[]
  kpiValues         KpiValue[]

  @@unique([organizationId, periodStart, periodEnd])
  @@index([organizationId, periodStart, periodEnd])
}

model DepartmentMetric {
  id             String   @id @default(cuid())
  snapshotId     String
  departmentId   String
  organizationId String
  revenue        Decimal  @db.Decimal(18, 2)
  cost           Decimal  @db.Decimal(18, 2)
  profit         Decimal  @db.Decimal(18, 2)
  margin         Float
  revenueShare   Float
  createdAt      DateTime @default(now())

  snapshot     ProfitabilitySnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  department   Department            @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([snapshotId, departmentId])
  @@index([departmentId])
  @@index([organizationId])
}

model CostCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String?  @unique
  description String?
  sortOrder   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  entries CostEntry[]
}

model CostEntry {
  id         String   @id @default(cuid())
  snapshotId String
  categoryId String
  amount     Decimal  @db.Decimal(18, 2)
  percentage Float
  createdAt  DateTime @default(now())

  snapshot ProfitabilitySnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  category CostCategory          @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([snapshotId, categoryId])
}

model KpiDefinition {
  id           String    @id @default(cuid())
  label        String
  slug         String    @unique
  description  String?
  format       KpiFormat @default(PERCENTAGE)
  targetValue  Decimal?  @db.Decimal(18, 2)
  targetMargin Float?
  sectorId     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  sector    Sector?    @relation(fields: [sectorId], references: [id], onDelete: SetNull)
  kpiValues KpiValue[]
}

model KpiValue {
  id           String   @id @default(cuid())
  snapshotId   String
  kpiId        String
  value        Decimal  @db.Decimal(18, 2)
  deltaPercent Float?
  trend        Trend    @default(NEUTRAL)
  notes        String?
  createdAt    DateTime @default(now())

  snapshot ProfitabilitySnapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)
  kpi      KpiDefinition         @relation(fields: [kpiId], references: [id], onDelete: Cascade)

  @@unique([snapshotId, kpiId])
}
